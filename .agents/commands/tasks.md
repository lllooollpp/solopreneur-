---
description: 基于设计文档生成可执行 tasks.md，任务分阶段、分用户故事组织。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json
  ps: scripts/powershell/check-prerequisites.ps1 -Json
---

## 用户输入

```text
$ARGUMENTS
```

---
   - 如果存在 contracts/：将端点映射到用户故事
   - 如果存在 research.md：为设置任务提取决策
   - 生成按用户故事组织的任务（见下面的任务生成规则）
   - 生成显示用户故事完成顺序的依赖图
   - 验证任务完整性（每个用户故事有所有需要的任务，独立可测试）

4. **生成 tasks.md**：使用 `.specify/templates/tasks-template.md` 作为结构，填入：
   - plan.md 中的正确功能名称
   - 第 1 阶段：设置任务（项目初始化）
   - 第 2 阶段：基础任务（所有用户故事的阻塞性先决条件）
   - 第 3+ 阶段：每个用户故事一个阶段（按 spec.md 中的优先级顺序）
   - 每个阶段包括：故事目标、独立测试标准、测试（如果请求）、实现任务
   - 最后阶段：完善和跨领域关注点
   - 所有任务必须遵循严格的检查清单格式（见下面的任务生成规则）
   - 每个任务都有明确的文件路径
   - 依赖关系部分显示故事完成顺序
   - 每个故事的并行执行示例
   - 实现策略部分（首先 MVP，增量交付）

5. **报告**：输出生成的 tasks.md 的路径和摘要：
   - 任务总数
   - 每个用户故事的任务数
   - 识别的并行机会
   - 每个故事的独立测试标准
   - 建议的 MVP 范围（通常只是用户故事 1）
   - 格式验证：确认所有任务遵循检查清单格式（复选框、ID、标签、文件路径）

任务生成的上下文：{ARGS}

tasks.md 应该是立即可执行的 - 每个任务都必须具体到足以让 LLM 不需要额外上下文就能完成它。

## 任务生成规则

**关键**：任务必须按用户故事组织，以实现独立实现和测试。

**测试是可选的**：仅在功能规范中明确要求或用户请求 TDD 方法时才生成测试任务。

### 检查清单格式（必需）

每个任务必须严格遵循此格式：

```text
- [ ] [TaskID] [P?] [Story?] 带文件路径的描述
```

**格式组件**：

1. **复选框**：始终以 `- [ ]`（markdown 复选框）开始
2. **任务 ID**：按执行顺序的序列号（T001、T002、T003...）
3. **[P] 标记**：仅当任务可并行化时包含（不同文件，对未完成任务无依赖）
4. **[Story] 标签**：仅用户故事阶段任务需要
   - 格式：[US1]、[US2]、[US3] 等（映射到 spec.md 中的用户故事）
   - 设置阶段：无故事标签
   - 基础阶段：无故事标签
   - 用户故事阶段：必须有故事标签
   - 完善阶段：无故事标签
5. **描述**：带确切文件路径的明确动作

**示例**：

- ✅ 正确：`- [ ] T001 按实现计划创建项目结构`
- ✅ 正确：`- [ ] T005 [P] 在 src/middleware/auth.py 中实现认证中间件`
- ✅ 正确：`- [ ] T012 [P] [US1] 在 src/models/user.py 中创建 User 模型`
- ✅ 正确：`- [ ] T014 [US1] 在 src/services/user_service.py 中实现 UserService`
- ❌ 错误：`- [ ] 创建 User 模型`（缺少 ID 和故事标签）
- ❌ 错误：`T001 [US1] 创建模型`（缺少复选框）
- ❌ 错误：`- [ ] [US1] 创建 User 模型`（缺少任务 ID）
- ❌ 错误：`- [ ] T001 [US1] 创建模型`（缺少文件路径）

### 任务组织

1. **来自用户故事（spec.md）** - 主要组织：
   - 每个用户故事（P1、P2、P3...）都有自己的阶段
   - 将所有相关组件映射到其故事：
     - 该故事所需的模型
     - 该故事所需的服务
     - 该故事所需的端点/UI
     - 如果请求测试：特定于该故事的测试
   - 标记故事依赖（大多数故事应该是独立的）

2. **来自合约**：
   - 将每个合约/端点 → 映射到其服务的用户故事
   - 如果请求测试：每个合约 → 该故事阶段中实现前的合约测试任务 [P]

3. **来自数据模型**：
   - 将每个实体映射到需要它的用户故事
   - 如果实体服务多个故事：放在最早的故事或设置阶段
   - 关系 → 适当故事阶段中的服务层任务

4. **来自设置/基础设施**：
   - 共享基础设施 → 设置阶段（第 1 阶段）
   - 基础/阻塞任务 → 基础阶段（第 2 阶段）
   - 故事特定设置 → 在该故事的阶段内

### 阶段结构

- **第 1 阶段**：设置（项目初始化）
- **第 2 阶段**：基础（阻塞性先决条件 - 必须在用户故事前完成）
- **第 3+ 阶段**：按优先级顺序的用户故事（P1、P2、P3...）
  - 在每个故事内：测试（如果请求）→ 模型 → 服务 → 端点 → 集成
  - 每个阶段应该是一个完整的、独立可测试的增量
- **最后阶段**：完善和跨领域关注点
