
---
description: 规范分析：在生成 tasks.md 后，对 spec.md、plan.md、tasks.md 进行一致性与质量分析（只读，不修改文件）。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## 用户输入

```text
$ARGUMENTS
```

请务必在分析前充分考虑用户输入（如有）。

## 目标

在实现前，识别规范、计划、任务三大核心文档（spec.md、plan.md、tasks.md）中的不一致、重复、歧义和未明确项。仅在 /speckit.tasks 生成完整 tasks.md 后运行。

## 约束

**严格只读**：禁止修改任何文件，仅输出结构化分析报告。可选提供修正建议（需用户确认后手动执行）。

**宪章权威**：项目宪章（/memory/constitution.md）为最高原则，分析中如有冲突，必须调整 spec、plan 或 tasks，不能弱化或忽略宪章内容。如需修改宪章，需单独显式操作。

## 执行步骤

1. 初始化分析上下文
  - 运行 `{SCRIPT}`，解析 FEATURE_DIR 和 AVAILABLE_DOCS，推导 spec.md、plan.md、tasks.md 路径。
  - 如缺少必要文件，报错并提示补全。

2. 渐进式加载文档关键信息：
  - spec.md：背景、功能/非功能需求、用户故事、边界场景
  - plan.md：架构/技术选型、数据模型、阶段划分、技术约束
  - tasks.md：任务ID、描述、阶段、并行标记、涉及文件
  - 宪章：加载 /memory/constitution.md 进行原则校验

3. 构建语义模型：
  - 需求清单、用户故事/动作清单、任务覆盖映射、宪章规则集

4. 检查与检测：
  - 重复项、歧义、未明确、宪章冲突、覆盖缺口、不一致

5. 严重性分级：
  - 严重（CRITICAL）：违反宪章、缺失核心文档、关键需求无覆盖
  - 高（HIGH）：重复/冲突需求、模糊安全/性能属性、不可验证标准
  - 中（MEDIUM）：术语漂移、非功能任务缺失、边界未明
  - 低（LOW）：表述优化、轻微冗余

6. 输出分析报告（Markdown 表格）：
  - ID | 类别 | 严重性 | 位置 | 摘要 | 建议
  - 覆盖率统计表、宪章冲突、未映射任务、各类计数

7. 下一步建议：
  - 有严重问题建议先修复
  - 仅低/中问题可继续，但建议完善
  - 明确推荐后续命令

8. 修正建议：
  - 询问用户是否需要针对高优先级问题生成具体修正建议（不自动应用）。

## 原则
- 只读分析，不修改文件
- 优先宪章冲突
- 结果可复现
- 零问题时输出通过报告

## 上下文

{ARGS}

## User Input

```text
$ARGUMENTS
```

您**必须**在继续之前考虑用户输入（如果不为空）。

## 目标

在实现前，识别三个核心构件（`spec.md`、`plan.md`、`tasks.md`）中的不一致、重复、歧义和未明确项。此命令**必须**仅在 `/speckit.tasks` 成功生成完整的 `tasks.md` 后运行。

## 操作约束

**严格只读**：**不要**修改任何文件。输出结构化分析报告。提供可选的修正计划（用户必须明确批准，然后手动调用任何后续编辑命令）。

**宪章权威**：项目宪章（`/memory/constitution.md`）在此分析范围内是**不可协商的**。宪章冲突自动被视为 CRITICAL，需要调整规范、计划或任务 - 而不是稀释、重新解释或静默忽略原则。如果原则本身需要更改，必须在 `/speckit.analyze` 之外单独明确的宪章更新中进行。

## 执行步骤

### 1. 初始化分析上下文

从仓库根目录运行一次 `{SCRIPT}` 并解析 JSON 以获取 FEATURE_DIR 和 AVAILABLE_DOCS。推导绝对路径：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如果缺少任何必需文件，则中止并显示错误消息（指示用户运行缺少的先决条件命令）。
对于参数中的单引号如 "I'm Groot"，使用转义语法：例如 'I'\''m Groot'（或者可能的话使用双引号："I'm Groot"）。

### 2. 加载构件（渐进式披露）

仅从每个构件加载最少必要的上下文：

**从 spec.md：**

- 概述/上下文
- 功能需求
- 非功能需求
- 用户故事
- 边界情况（如果存在）

**从 plan.md：**

- 架构/技术栈选择
- 数据模型引用
- 阶段
- 技术约束

**从 tasks.md：**

- 任务 ID
- 描述
- 阶段分组
- 并行标记 [P]
- 引用的文件路径

**从宪章：**

- 加载 `/memory/constitution.md` 进行原则验证

### 3. 构建语义模型

创建内部表示（不在输出中包含原始构件）：

- **需求清单**：每个功能和非功能需求都有一个稳定的键（基于祈使短语推导标识符；例如，"用户可以上传文件" → `user-can-upload-file`）
- **用户故事/动作清单**：具有验收条件的离散用户动作
- **任务覆盖映射**：将每个任务映射到一个或多个需求或故事（通过关键词/显式引用模式如 ID 或关键短语进行推断）
- **宪章规则集**：提取原则名称和 MUST/SHOULD 规范性陈述

### 4. 检测通道（令牌高效分析）

专注于高信号发现。限制为总共 50 个发现；在溢出摘要中汇总其余部分。

#### A. 重复检测

- 识别近似重复的需求
- 标记质量较低的措辞以进行合并

#### B. 歧义检测

- 标记缺乏可测量标准的模糊形容词（快速、可扩展、安全、直观、健壮）
- 标记未解决的占位符（TODO、TKTK、???、`<placeholder>` 等）

#### C. 规范不足

- 有动词但缺少对象或可测量结果的需求
- 缺少验收条件对齐的用户故事
- 引用规范/计划中未定义的文件或组件的任务

#### D. 宪章对齐

- 任何与 MUST 原则冲突的需求或计划元素
- 缺少宪章要求的部分或质量门槛

#### E. 覆盖缺口

- 零关联任务的需求
- 无映射需求/故事的任务
- 未在任务中反映的非功能需求（例如，性能、安全性）

#### F. 不一致

- 术语漂移（同一概念在文件间命名不同）
- 计划中引用但规范中不存在的数据实体（反之亦然）
- 任务排序矛盾（例如，集成任务在基础设置任务之前而没有依赖性说明）
- 需求冲突（例如，一个需要 Next.js，另一个指定 Vue）

### 5. 严重性分配

使用此启发式方法对发现进行优先级排序：

- **CRITICAL**：违反宪章 MUST、缺少核心规范构件，或需求零覆盖阻塞基线功能
- **HIGH**：重复或冲突需求、模糊的安全/性能属性、不可测试的验收标准
- **MEDIUM**：术语漂移、缺少非功能任务覆盖、规范不足的边界情况
- **LOW**：样式/措辞改进、不影响执行顺序的轻微冗余

### 6. 生成紧凑分析报告

输出 Markdown 报告（无文件写入），具有以下结构：

## 规范分析报告

| ID | 类别 | 严重性 | 位置 | 摘要 | 建议 |
|----|------|--------|------|------|------|
| A1 | 重复 | HIGH | spec.md:L120-134 | 两个相似需求... | 合并措辞；保留更清晰版本 |

（每个发现添加一行；生成以类别首字母为前缀的稳定 ID。）

**覆盖摘要表：**

| 需求键 | 有任务？ | 任务 ID | 备注 |
|--------|----------|---------|------|

**宪章对齐问题：**（如果有）

**未映射任务：**（如果有）

**指标：**

- 总需求数
- 总任务数
- 覆盖率 %（具有 >=1 个任务的需求）
- 歧义计数
- 重复计数
- 关键问题计数

### 7. 提供下一步动作

在报告末尾，输出简洁的下一步动作块：

- 如果存在 CRITICAL 问题：建议在 `/speckit.implement` 前解决
- 如果只有 LOW/MEDIUM：用户可以继续，但提供改进建议
- 提供明确的命令建议：例如，"运行 /speckit.specify 进行细化"、"运行 /speckit.plan 调整架构"、"手动编辑 tasks.md 为 'performance-metrics' 添加覆盖"

### 8. 提供修正

询问用户："您希望我为前 N 个问题建议具体的修正编辑吗？"（不要自动应用它们。）

## 操作原则

### 上下文效率

- **最少高信号令牌**：专注于可操作的发现，而不是详尽的文档
- **渐进式披露**：增量加载构件；不要将所有内容转储到分析中
- **令牌高效输出**：将发现表限制为 50 行；汇总溢出
- **确定性结果**：在没有更改的情况下重新运行应产生一致的 ID 和计数

### 分析指南

- **绝不修改文件**（这是只读分析）
- **绝不幻想缺失的部分**（如果不存在，准确报告它们）
- **优先处理宪章违规**（这些总是 CRITICAL）
- **使用示例而不是详尽规则**（引用具体实例，而不是通用模式）
- **优雅地报告零问题**（发出带有覆盖统计的成功报告）

## 上下文

{ARGS}
